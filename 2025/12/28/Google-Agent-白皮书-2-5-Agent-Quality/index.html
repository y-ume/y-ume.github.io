<!DOCTYPE html>
<html lang="zh-hans">
<head hexo-theme='https://github.com/volantis-x/hexo-theme-volantis/tree/4.2.0'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://cdn.jsdelivr.net'>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
  <title>Google Agent 白皮书 2/5 - Agent Quality - y-ume</title>
  
    <meta name="keywords" content="Agent">
  

  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  
    <link rel="shortcut icon" type='image/x-icon' href="https://cdn.jsdelivr.net/gh/y-ume/assets@main/favicon/マジョカップ.jpg">
  

  <!-- import link -->
  

  
    
<link rel="stylesheet" href="/css/first.css">

  

  
  <link rel="stylesheet" href="/css/style.css" media="print" onload="this.media='all';this.onload=null">
  <noscript><link rel="stylesheet" href="/css/style.css"></noscript>
  

  <script id="loadcss"></script>

</head>

<body>
  

<header id="l_header" class="l_header always shadow blur show"  >
  <div class='container'>
  <div id='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h m-phone' id="pjax-header-nav-list">
        <li><a id="s-comment" class="fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a id="s-toc" class="s-toc fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
          
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h m-pc'>
          
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fa fa-home fa-fw'></i>首页
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" 
                  
                  
                  >
                  <i class='fa fa-bars fa-fw'></i>导航
                </a>
                
                  <ul class="list-v">
                    
                      
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fa fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
                    
                      
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fa fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
                    
                      
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fa fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="Search..." />
        </form>
      </div>

			<ul class='switcher nav-list-h m-phone'>
				
					<li><a class="s-search fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li>
          <a class="s-menu fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fa fa-home fa-fw'></i>首页
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" 
                  
                  
                  >
                  <i class='fa fa-bars fa-fw'></i>导航
                </a>
                
                  <ul class="list-v">
                    
                      
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fa fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
                    
                      
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fa fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
                    
                      
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fa fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>
		</div>
	</div>
  </div>
</header>

  <div id="l_body">
    <div id="l_cover">
  
    
        <div id="full" class='cover-wrapper post dock' style="display: none;">
          
            <div class='cover-bg lazyload placeholder' data-bg="https://cdn.jsdelivr.net/gh/y-ume/assets@main/img/船.jpg"></div>
          
          <div class='cover-body'>
  <div class='top'>
    
    
    
  </div>
  <div class='bottom'>
    <div class='menu navigation'>
      <div class='list-h'>
        
      </div>
    </div>
  </div>
</div>

          <div id="scroll-down" style="display: none;"><i class="fa fa-chevron-down scroll-down-effects"></i></div>
        </div>
    
  
  </div>

    <div id='safearea'>
      <div class='body-wrapper' id="pjax-container">
        

<div class='l_main'>
  <article class="article post white-box reveal md shadow article-type-post" id="post" itemscope itemprop="blogPost">
  


  
  <div class="article-meta" id="top">
    
    
    
      <h1 class="title">
        Google Agent 白皮书 2/5 - Agent Quality
      </h1>
      <div class='new-meta-box'>
        
          
            
<div class='new-meta-item author'>
  <a class='author' href="/" rel="nofollow">
    <img no-lazy src="https://cdn.jsdelivr.net/gh/y-ume/assets@main/favicon/マジョカップ.jpg">
    <p>y-ume</p>
  </a>
</div>

          
        
          
            
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Agent/" rel="nofollow"><i class="fa fa-hashtag fa-fw" aria-hidden="true"></i><p>Agent</p></a></div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fa fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Dec 28, 2025</p>
  </a>
</div>

          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard fa-fw" aria-hidden="true"></i>
      <p>4.3k words</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half fa-fw" aria-hidden="true"></i>
      <p>15 min</p>
    </a>
  </div>


          
        
          
            
<div class="new-meta-item comments-count">
  
  <a href="/2025/12/28/Google-Agent-%E7%99%BD%E7%9A%AE%E4%B9%A6-2-5-Agent-Quality/#comments">
    <i class="fa fa-comment-dots fa-fw"></i>
    <span class="valine-comment-count" data-xid="/2025/12/28/Google-Agent-%E7%99%BD%E7%9A%AE%E4%B9%A6-2-5-Agent-Quality/">0</span>
    <span class="leancloud-comments-count">&nbsp;</span>
  </a>
</div>


          
        
      </div>
    
  </div>


  
  <ol>
<li>Introduction to Agents</li>
<li>Agent Tools &amp; Interoperability with MCP</li>
<li>→ Agent Quality</li>
<li>Context Engineering: Sessions, Memory</li>
<li>Prototype to Production<br>剩下的顺序可能按照3-2-4-5来读。让我们优先来读这篇Quality~<br>文中的<em>斜体</em>代表非原文但容易被理解为原文的内容。</li>
</ol>
<hr>
<p>依然是超大引用块（看了下其他几篇也都有）</p>
<blockquote>
<p>The future of AI is agentic. Its success is determined by quality.</p>
</blockquote>
<p>Agent固有的非确定性使其结果具有不一致性。<em>Agent的非确定性来自于内部的随机</em><br><em>不一致性对于软件工程来讲是件麻烦事，对于设计为期望有一致性结果的工具来说出现一致性的调试是很折磨的。这里有三重非确定性：第一重是Agent的过程非确定性；第二重是Agent的结果非确定性；第三重是评估标准非确定性。问题溯源的每一步都有不确定性存在，即概率存在</em></p>
<p>这本指南基于三部分构建：</p>
<ul>
<li><strong>轨迹是真相</strong>：不能只关注最终结果，而需要关注Agent整个决策过程的质量和安全性</li>
<li><strong>可观测性是基础</strong>：无法判断一个看不到的过程，需要有日志、追踪和指标</li>
<li><strong>评估是一个持续循环</strong>：Human-in-the-Loop (HITL, 人在回路)讲评估转化为数据，再转化为改进</li>
</ul>
<p>这篇白皮书有读者定位了：</p>
<ul>
<li>面向<strong>所有读者</strong>：关注《非确定性世界中的Agent Quality》章节，理解核心问题：为什么传统的QA对AI Agent失效了。认识AI Agents质量评估的四大支柱：有效性、效率、稳健性和安全性。</li>
<li>面向产品经理、数据科学家和QA负责人：重点关注《Agent评估艺术：过程评估》章节，了解评估「Outside-In」的层级结构、「LLM-as-a-Judge」的范式和人在循环的重要性。</li>
<li>面向工程师、架构师和SRE（站点可靠性工程师）：重点关注《可观测性》章节，了解监控和可观测性的区别，认识三大支柱：日志、追踪和指标。</li>
<li>面向团队负责人和策略师：阅读《总结》章节。该章节整合了上述概念形成可操作的手册，介绍了《Agent Quality Flywheel》迭代模型，总结了构建可信AI的三个核心原则。<br><em>后三个方向可以理解为「如何评价」、「如何找问题」、「如何迭代」</em></li>
</ul>
<h1 id="非确定性世界中的Agent-Quality"><a href="#非确定性世界中的Agent-Quality" class="headerlink" title="非确定性世界中的Agent Quality"></a>非确定性世界中的Agent Quality</h1><p>传统软件比作了送货卡车；AI agent比作了F1赛车。</p>
<img src="/2025/12/28/Google-Agent-%E7%99%BD%E7%9A%AE%E4%B9%A6-2-5-Agent-Quality/F1%E8%B5%9B%E8%BD%A6vs%E9%80%81%E8%B4%A7%E5%8D%A1%E8%BD%A6.png" class="lazyload" data-srcset="/2025/12/28/Google-Agent-%E7%99%BD%E7%9A%AE%E4%B9%A6-2-5-Agent-Quality/F1%E8%B5%9B%E8%BD%A6vs%E9%80%81%E8%B4%A7%E5%8D%A1%E8%BD%A6.png" srcset="data:image/png;base64,666" class=" lazyload">
<p>即使Agent通过了100项单元测试，却仍会在实际应用中出现灾难性故障。<br><em>Agent的结果可能性更多了，测试的空间变得更大了</em><br>传统软件会问「Did we build the product right?」<br>AI Agent会问「Did we build the right product?」<br><em>AI Agent的能力是非线性的，调用的LM模块的准确结果是不可预估的</em></p>
<h2 id="为什么Agent质量需要新方法"><a href="#为什么Agent质量需要新方法" class="headerlink" title="为什么Agent质量需要新方法"></a>为什么Agent质量需要新方法</h2><p> 传统软件中，故障是明确的：系统崩溃、抛出空指针异常，或者返回明显错误的计算结果。通过追溯可以找到问题引入点。但AI agents的错误是质量的细微下降，具有隐蔽性：返回结果成功，输出看似合理，但存在严重错误且有操作危险性。<br> <em>在传统软件中的复杂优化问题也会有细微质量下滑的现象，是较难识别的</em><br> 未能把握这一转变的组织将面临重大失败、运营效率低下和声誉受损的风险。<br><em>可以预见未来更多的AI Agent软件上线后，会看到很多奇奇怪怪的bug</em><br>以下是四种现实世界的失败模式：</p>
<table>
<thead>
<tr>
<th><strong>故障模式</strong></th>
<th><strong>描述</strong></th>
<th><strong>示例</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>算法偏见</strong> (Algorithmic Bias)</td>
<td>智能体在运行中执行并可能放大训练数据中存在的系统性偏见，导致不公平或歧视性的结果。</td>
<td>• 负责风险总结的金融智能体，根据训练数据中的偏见，对特定邮政编码的贷款申请进行过度惩罚。</td>
</tr>
<tr>
<td><strong>事实幻觉</strong> (Factual Hallucination)</td>
<td>智能体生成看似合理但实际上错误或虚构的信息，且表现出极高的自信。这通常发生在它无法找到有效来源时。</td>
<td>• 研究工具在学术报告中生成了一个非常具体但完全错误的日期或地理位置，损害了学术诚信。</td>
</tr>
<tr>
<td><strong>性能与概念漂移</strong> (Performance &amp; Concept Drift)</td>
<td>随着智能体交互的现实世界数据（即“概念”）发生变化，其原始训练内容变得过时，导致智能体的性能随时间而下降。</td>
<td>• 欺诈检测智能体无法识别出新的攻击模式。</td>
</tr>
<tr>
<td><strong>突发非预期行为</strong> (Emergent Unintended Behaviors)</td>
<td>智能体为了实现目标而演化出新颖或意想不到的策略，这些策略可能效率低下、无益甚至具有剥削性。</td>
<td>• 寻找并利用系统规则中的漏洞。<br>• 与其他机器人进行“代理战争”（例如：反复覆盖对方的编辑内容）。</td>
</tr>
</tbody></table>
<p>这些问题无法用断点调试来解决。<em>一致性问题导致问题复现的概率指数下降</em><br>无法编写单元测试来防止涌现性偏见。<em>无法定义边界case</em><br>需要深入数据分析、模型重新训练和系统性评估 – <strong>这是一门新学科</strong></p>
<p><em>算法偏见：根据数据驱动的招聘算法已经有很强的偏见</em><br><em>事实幻觉：文献准确度这几年已经提升了不少；Gemini的Double-check response挺好用的</em><br><em>性能与概念漂移：第一章提到可以用人在回路来纠正；旧数据该如何去清洗呢？</em><br><em>突发非预期行为：目的为导向的设计的天生问题。给予更多的权限，就会有更大的风险</em></p>
<h2 id="范式转变：从可预测的代码到不可预测的智能体"><a href="#范式转变：从可预测的代码到不可预测的智能体" class="headerlink" title="范式转变：从可预测的代码到不可预测的智能体"></a>范式转变：从可预测的代码到不可预测的智能体</h2><img src="/2025/12/28/Google-Agent-%E7%99%BD%E7%9A%AE%E4%B9%A6-2-5-Agent-Quality/%E4%BB%8E%E4%BC%A0%E7%BB%9F%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%88%B0%E5%A4%9A%E6%99%BA%E8%83%BD%E4%BD%93%E7%B3%BB%E7%BB%9F.png" class="lazyload" data-srcset="/2025/12/28/Google-Agent-%E7%99%BD%E7%9A%AE%E4%B9%A6-2-5-Agent-Quality/%E4%BB%8E%E4%BC%A0%E7%BB%9F%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%88%B0%E5%A4%9A%E6%99%BA%E8%83%BD%E4%BD%93%E7%B3%BB%E7%BB%9F.png" srcset="data:image/png;base64,666" class=" lazyload">
<p><em>根据Google Agent System Level定义，从左到右可以认为是从L-1到L3</em></p>
<ol>
<li>传统机器学习：通过Precision、Recall、F1-Score和RMSE评估。问题复杂但正确的标准清晰</li>
<li>被动LLM：输出有概率性。评估变得复杂，需要依赖人工评分和模型间的基准测试。</li>
<li>LLM+RAG：糟糕的答案可能因为LLM推理能力差或者向量数据库检索到了不相关的片段。</li>
<li>主动式AI Agent：进一步需要评估思考、行动、观察、工具调用、记忆这几个构建。</li>
<li>Multi-Agent：需要评估系统级涌现现象，带来了新的挑战：突发系统故障和协作和竞争式评估。前者包括智能体间的资源竞争、通信瓶颈和系统系死锁；<br><em>随着系统的扩充，评估的难度会越来越大。到LLM Agents就需要用人的方式来评估；到Multi-Agent需要用团队的方式来评估。</em></li>
</ol>
<h1 id="Agent评估艺术：过程评估"><a href="#Agent评估艺术：过程评估" class="headerlink" title="Agent评估艺术：过程评估"></a>Agent评估艺术：过程评估</h1><p>分为四大支柱：</p>
<ol>
<li>Effectiveness, <strong>有效性</strong>：衡量任务成功与否。</li>
<li>Efficiency, <strong>效率</strong>：衡量是否很好地解决了问题。关注token消耗、实际时间和轨迹复杂度。</li>
<li>Robustnees, <strong>稳健性</strong>：当现实世界混乱时，是否能平稳处理。接口超时、数据缺失、用户提示模糊等。</li>
<li>Safety &amp; Alignment, <strong>安全与对齐</strong>：是否在定义的伦理边界和约束范围内运行。<br>一个全面的Agent Quality框架需要一个全面的Agent可见性架构。<br>核心问题是「Did we build the <em><strong>right</strong></em> product?」<br><em>这里的right是带有疑惑的提出的。噼里啪啦两三下弄出一个Agent，然后简单试了下没问题，随后开始问「这对吗？」</em><br>对于Agent这类新式软件，不能只评估结果，还需要评估过程。</li>
</ol>
<h2 id="Outside-In的层级评估"><a href="#Outside-In的层级评估" class="headerlink" title="Outside-In的层级评估"></a>Outside-In的层级评估</h2><p>我们的方法还是传统的那套：追本溯源。这里叫做「Outside-In」</p>
<img src="/2025/12/28/Google-Agent-%E7%99%BD%E7%9A%AE%E4%B9%A6-2-5-Agent-Quality/%E8%AF%84%E4%BC%B0%E6%A1%86%E6%9E%B6.png" class="lazyload" data-srcset="/2025/12/28/Google-Agent-%E7%99%BD%E7%9A%AE%E4%B9%A6-2-5-Agent-Quality/%E8%AF%84%E4%BC%B0%E6%A1%86%E6%9E%B6.png" srcset="data:image/png;base64,666" class=" lazyload">
<p>评估层第一个问题「Output evaluation」，即「Agent是否有效地实现了用户目标？」<br>我们衡量：</p>
<ul>
<li><strong>任务成功率</strong>：是否成功解决了二元或者分级问题</li>
<li><strong>用户满意度</strong>：用户反馈评分</li>
<li><strong>整体质量</strong>：如果目标是定量的，需要评估准确度和完整度</li>
</ul>
<h2 id="Inside-Out视角：轨迹评估"><a href="#Inside-Out视角：轨迹评估" class="headerlink" title="Inside-Out视角：轨迹评估"></a>Inside-Out视角：轨迹评估</h2><p>从Outside-In视角发现问题后，为我们就转向Inside-Out视角。<br>我们通过系统地评估Agent执行轨迹来分析：</p>
<ul>
<li>LLM的规划：检查核心推理过程。</li>
<li>工具使用：是否调用了正确的工具、必要的工具。是否使用正确。</li>
<li>工具观察结果的解读：是否理解工具的结果。</li>
<li>RAG性能：是否通过RAG找到关键的信息，而不是无用的信息。或者LM无视了检索到的信息。</li>
<li>轨迹效率和稳健性：是否有低效的资源分配，是否能处理异常。</li>
<li>多智能体动态：智能体检是否存在误解或者死循环，是否存在冲突。<br><em>就是把最终问题拆解到各个组件。思考：用个Agent做这个事情也是可以的</em></li>
</ul>
<h2 id="评估器：评估什么以及如何评估"><a href="#评估器：评估什么以及如何评估" class="headerlink" title="评估器：评估什么以及如何评估"></a>评估器：评估什么以及如何评估</h2><h3 id="自动化指标"><a href="#自动化指标" class="headerlink" title="自动化指标"></a>自动化指标</h3><p> 即具备快速、量化性的指标，例如基于字符串相似度、基于嵌入的相似度<br> 提到TruthfulQA的任务基准<br> <em>后面有时间来解读下各类Benchmark</em><br> 自动化指标是第一道关卡，主要用来查看宏观趋势变化</p>
<h3 id="LLM-as-a-Judge"><a href="#LLM-as-a-Judge" class="headerlink" title="LLM-as-a-Judge"></a>LLM-as-a-Judge</h3><p>采用LLM来评估。用LLM我们就可以构建「这个摘要好不好？」、「这个计划是否合乎逻辑」这类评价标准了。通过提供Agent的输入、原始提示词、参考答案和评估标准，LLM可以进行逻辑推导形成分析。推荐使用比较两个Agent的方式来做相对评估。</p>
<h3 id="Agent-as-a-Judge"><a href="#Agent-as-a-Judge" class="headerlink" title="Agent-as-a-Judge"></a>Agent-as-a-Judge</h3><p>采用Agent来评估Agent。<em>Agent评估思考伏笔收回</em><br>关键的评价维度包括：</p>
<ul>
<li>计划质量：规划是否清晰且可行？</li>
<li>工具使用：是否选择了正确的工具并正确使用？</li>
<li>上下文处理：是否有效地利用了先前的信息？<br>Agent需要提供信息的日志</li>
</ul>
<h3 id="Human-in-the-Loop"><a href="#Human-in-the-Loop" class="headerlink" title="Human-in-the-Loop"></a>Human-in-the-Loop</h3><p>人在回路在处理深度主观性和复杂领域知识方面发挥重要作用。<br>HITL是建立径人类校准的基准的不可或缺的方法，可以确保Agent的行为符合复杂的人类价值观、情景需求以及特定领域的准确性。</p>
<h3 id="用户反馈和Reviewer界面"><a href="#用户反馈和Reviewer界面" class="headerlink" title="用户反馈和Reviewer界面"></a>用户反馈和Reviewer界面</h3><p>评估还要收集真实世界的用户反馈，包括点赞、点踩、快速划过和短评论<br>点踩行为发生后，评估会将这次案例呈现到Reviewer的UI中，来定位问题</p>
<h2 id="负责任的AI与安全评估"><a href="#负责任的AI与安全评估" class="headerlink" title="负责任的AI与安全评估"></a>负责任的AI与安全评估</h2><p><em>未来对于Agent安全性的评估和提升绝对是一个大难题</em><br>这里提供三种手段：</p>
<ul>
<li>系统性红队测试：构建对抗性场景来破坏Agent的行为</li>
<li>自动过滤与人工审核：用硬性标准来过滤信息，并结合人工评审</li>
<li>遵守指南：通过定义好的道德标准和原则评估Agent的属猪，确保一致性<br><em>如果Agent Systeam到达L4的话，Agent创建的Agent又该如何去控制其安全性呢？以及如果一个系统都是由Agent构成的，如何确保这个系统是安全的呢？</em></li>
</ul>
<h1 id="可观测性"><a href="#可观测性" class="headerlink" title="可观测性"></a>可观测性</h1><p>一个很有趣的类比：</p>
<ul>
<li>传统软件像是流水线厨师，制作汉堡用的是严格且确定的流程<ul>
<li>监控就是确认每一步操作是否争取</li>
<li><em>类比软件开发就是按照变量、函数、判断、循环来提前脑测运行逻辑</em></li>
</ul>
</li>
<li>AI Agent就像是神秘盒挑战赛的美食大厨：大厨收到目标「制作一款绝妙的甜点」和一篮食材。大厨可能会做出巧克力熔岩蛋糕、解构版提拉米苏或者藏红花风味的意式奶冻。<ul>
<li>需要从监控面向观测，理解其制作甜点的过程</li>
<li><em>类比软件开发就是在Agent Think-Action-Observe过程中确认每一步的动作合理性。我们在一个While循环中塞入了几个Tool和提示词，但Agent的行为就会因为这些改动而产生非线性变化，较传统软件开发而言这是非常夸张的。你所见的代码外表已经不能呈现这个函数的变化，你需要结合对业务场景去推演他会走什么流程。</em><br>  可观测行的三大支柱：日志、追踪和指标</li>
</ul>
</li>
</ul>
<h2 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h2><p>记录每个动作的时间、行为<br>我们需要重建Agent的思维过程，必须要包括丰富的上下文。</p>
<ul>
<li>核心信息：完整的上下文：提示词&#x2F;响应对、中间推理步骤（思维链）、结构化的工具调用（输入、输出、错误）以及Agent内部状态的变化<ul>
<li><em>简而言之就是DB变化、Function调用、LLM询问。和传统的软件相比，我们增加了LLM询问这个步骤。这个步骤是Agent软件的核心变化，我们需要关注每一个LLM询问的输入和输出都是什么才能理解一次Agent运行的思考部分。本质上传统软件将部分函数通过LM方式实现就构成Agent了，获得了泛化性但也失去了可控性。</em></li>
</ul>
</li>
<li>Tradeoff：要注意不能存储导致性能开销过大的信息。</li>
</ul>
<h2 id="追踪"><a href="#追踪" class="headerlink" title="追踪"></a>追踪</h2><p>在日志的基础上，查看这一次运行结果出问题的地方。<br>又推荐了一次OpenTelemetry。人去确认的话可视化可以提升很多效率。<br>除了生命周期、属性监控等传统软件概念外，需要增加一个LLM对话的监控</p>
<h2 id="指标"><a href="#指标" class="headerlink" title="指标"></a>指标</h2><p>依据日志和追踪，需要评估Agent的系统指标：</p>
<ul>
<li>性能：延迟、错误率</li>
<li>成本：token总数、API成本</li>
<li>有效性：任务完成率、工具使用频率<br>对于运营、设置预警机制而言成本和性能至关重要。<em>三个指标加在一起就能评估完成一项任务的经济和时间成本。</em><br>除了系统指标，还需要关注质量指标：</li>
<li>正确性与准确性</li>
<li>轨迹遵循度</li>
<li>安全性和责任性</li>
<li>有用性与相关性<br><em>系统指标可以简单运算获得；质量指标如果不通过LLM和Agent感觉不太能落地，但是评估Agent质量的Agent又该如何评估呢？无线套娃同时引入HITL？可能2-3个Agent配合HITL就可以运行</em></li>
</ul>
<h2 id="整合所有要素"><a href="#整合所有要素" class="headerlink" title="整合所有要素"></a>整合所有要素</h2><p>拥有了日志、追踪和指标后，我们需要将这个要素系统地组织起来<br>三个关键的运营实践：</p>
<ul>
<li>仪表盘与告警：<em>一个层次化且美观的仪表盘（系统指标、质量指标）；一个及时反馈预警的通信管道</em></li>
<li>安全性与个人身份信息：要保证整个监控需要保护用户信息。<em>这一点如何监管？如果不是本地部署LLM全靠自觉？</em></li>
<li>粒度和开销的权衡：观测不能影响到运行效率的。建议用动态采样法：开发用DEBUG日志，生产环境采用较低的INFO日志并且跟踪所有的错误和部分的正确请求。</li>
</ul>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>这一篇会整合上述的内容，讲抽象原则转为可靠、自我改进系统的操作手册。<br>文中称之为 智能体质量飞轮。</p>
<img src="/2025/12/28/Google-Agent-%E7%99%BD%E7%9A%AE%E4%B9%A6-2-5-Agent-Quality/%E6%99%BA%E8%83%BD%E4%BD%93%E8%B4%A8%E9%87%8F%E9%A3%9E%E8%BD%AE.png" class="lazyload" data-srcset="/2025/12/28/Google-Agent-%E7%99%BD%E7%9A%AE%E4%B9%A6-2-5-Agent-Quality/%E6%99%BA%E8%83%BD%E4%BD%93%E8%B4%A8%E9%87%8F%E9%A3%9E%E8%BD%AE.png" srcset="data:image/png;base64,666" class=" lazyload">
<p>由四部分组成：</p>
<ol>
<li>定义质量（目标）：我们需要一个方向，始于质量的四大支柱：有效性、成本效益、安全性和用户信任。<em>这里的四个支柱和前面提到的四个支柱没有完全对齐，但内容是基本一致的。</em> 需要思考具体的工作我们需要怎么定义以上几点的要求。</li>
<li>配置可见性工具（基础）：需要构建Agent的结构化日志、端到端追踪。可观测性是生成【衡量质量支柱】证据的基础实践。</li>
<li>评估过程（引擎）：我们采用Outside-In的方式既评估最终的输出，也评判整个运行过程。可以采用LLM-as-a-Judge来保证效率，采用人在回路的标准来确保基准事实。</li>
<li>构建反馈循环（动量）：我们要确保每一次生产故障在被捕获和标注年后，都能通过程序转换为回归测试。<br>贴心地提到如果白皮书没记住什么，至少要记住三条原则：</li>
</ol>
<ul>
<li>评估是架构支柱：<em>评估不再只仅看结果，也需要评估日志和跟踪信息</em></li>
<li>轨迹即真相：<em>Agent软件是需要打开盒子去深入查看思维过程的</em></li>
<li>人类是仲裁者：软件需要基于人类价值观，人在回路是连接真实世界和Agent的桥梁<br><em>我们需要构建<strong>能被信任</strong>的Agent，而不仅仅是能运行的Agent</em></li>
</ul>
<p>写于2025-12-28</p>

  
  
    
    <div class='footer'>
      
      
      
      
    </div>
  
  
    


  <div class='article-meta' id="bottom">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2025-12-28T21:11:26+08:00">
  <a class='notlink'>
    <i class="fa fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：Dec 28, 2025</p>
  </a>
</div>

        
      
        
          

        
      
    </div>
  </div>


  
  

  
    <div class="prev-next">
      
      
        <a class='next' href='/2025/12/26/Google-Agent-%E7%99%BD%E7%9A%AE%E4%B9%A6-1-5-%E8%AE%A4%E8%AF%86Agent/'>
          <p class='title'>Google Agent 白皮书 1/5 - 认识Agent<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
          <p class='content'>写在前面在Google Gemini 3发布前一周Google发了一系列关于Agent的白皮书，总共5本：

Introduction to Agents
Agent Tools &amp; I...</p>
        </a>
      
    </div>
  
</article>


  

  <article class="post white-box reveal shadow" id="comments">
    <p ct><i class='fas fa-comments'></i> 评论</p>
    
    <div id="valine_container" class="valine_thread">
  <i class="fas fa-cog fa-spin fa-fw fa-2x"></i>
</div>

  </article>






</div>
<aside class='l_side'>
  
  
    
    



  <section class="widget toc-wrapper shadow desktop mobile" id="toc-div" >
    
  <header>
    
      <i class="fa fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88Agent%E8%B4%A8%E9%87%8F%E9%9C%80%E8%A6%81%E6%96%B0%E6%96%B9%E6%B3%95"><span class="toc-text">为什么Agent质量需要新方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8C%83%E5%BC%8F%E8%BD%AC%E5%8F%98%EF%BC%9A%E4%BB%8E%E5%8F%AF%E9%A2%84%E6%B5%8B%E7%9A%84%E4%BB%A3%E7%A0%81%E5%88%B0%E4%B8%8D%E5%8F%AF%E9%A2%84%E6%B5%8B%E7%9A%84%E6%99%BA%E8%83%BD%E4%BD%93"><span class="toc-text">范式转变：从可预测的代码到不可预测的智能体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Outside-In%E7%9A%84%E5%B1%82%E7%BA%A7%E8%AF%84%E4%BC%B0"><span class="toc-text">Outside-In的层级评估</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Inside-Out%E8%A7%86%E8%A7%92%EF%BC%9A%E8%BD%A8%E8%BF%B9%E8%AF%84%E4%BC%B0"><span class="toc-text">Inside-Out视角：轨迹评估</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%84%E4%BC%B0%E5%99%A8%EF%BC%9A%E8%AF%84%E4%BC%B0%E4%BB%80%E4%B9%88%E4%BB%A5%E5%8F%8A%E5%A6%82%E4%BD%95%E8%AF%84%E4%BC%B0"><span class="toc-text">评估器：评估什么以及如何评估</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E6%8C%87%E6%A0%87"><span class="toc-text">自动化指标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LLM-as-a-Judge"><span class="toc-text">LLM-as-a-Judge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Agent-as-a-Judge"><span class="toc-text">Agent-as-a-Judge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Human-in-the-Loop"><span class="toc-text">Human-in-the-Loop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%8F%8D%E9%A6%88%E5%92%8CReviewer%E7%95%8C%E9%9D%A2"><span class="toc-text">用户反馈和Reviewer界面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%B4%A3%E4%BB%BB%E7%9A%84AI%E4%B8%8E%E5%AE%89%E5%85%A8%E8%AF%84%E4%BC%B0"><span class="toc-text">负责任的AI与安全评估</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-text">日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%BD%E8%B8%AA"><span class="toc-text">追踪</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%87%E6%A0%87"><span class="toc-text">指标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E5%90%88%E6%89%80%E6%9C%89%E8%A6%81%E7%B4%A0"><span class="toc-text">整合所有要素</span></a></li></ol>
    </div>
  </section>


  


</aside>



        
        
          <!--此文件用来存放一些不方便取值的变量-->
<!--思路大概是将值藏到重加载的区域内-->

<script>
  window.pdata={}
  pdata.ispage=true;
  pdata.postTitle="Google Agent 白皮书 2/5 - Agent Quality";
  pdata.commentPath="";
  pdata.commentPlaceholder="";

  var l_header=document.getElementById("l_header");
  
  l_header.classList.add("show");
  
</script>

        
      </div>
      
  
  <footer class="footer clearfix">
    <br><br>
    
      
        
          <div><p>由 <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">hexo</a> 驱动 | 主题 <a target="_blank" rel="noopener" href="https://github.com/volantis-x/hexo-theme-volantis">volantis</a> <br> <a href="/">Copyright © 2017-2025 y-ume</a></p>
</div>
        
      
    
  </footer>


      <a id="s-top" class="fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
    </div>
  </div>
  <div>
    <script>
window.volantis={};
window.volantis.loadcss=document.getElementById("loadcss");
/********************脚本懒加载函数********************************/
function loadScript(src, cb) {
var HEAD = document.getElementsByTagName('head')[0] || document.documentElement;
var script = document.createElement('script');
script.setAttribute('type','text/javascript');
if (cb) script.onload = cb;
script.setAttribute('src', src);
HEAD.appendChild(script);
}
//https://github.com/filamentgroup/loadCSS
var loadCSS = function( href, before, media, attributes ){
	var doc = window.document;
	var ss = doc.createElement( "link" );
	var ref;
	if( before ){
		ref = before;
	}
	else {
		var refs = ( doc.body || doc.getElementsByTagName( "head" )[ 0 ] ).childNodes;
		ref = refs[ refs.length - 1];
	}
	var sheets = doc.styleSheets;
	if( attributes ){
		for( var attributeName in attributes ){
			if( attributes.hasOwnProperty( attributeName ) ){
				ss.setAttribute( attributeName, attributes[attributeName] );
			}
		}
	}
	ss.rel = "stylesheet";
	ss.href = href;
	ss.media = "only x";
	function ready( cb ){
		if( doc.body ){
			return cb();
		}
		setTimeout(function(){
			ready( cb );
		});
	}
	ready( function(){
		ref.parentNode.insertBefore( ss, ( before ? ref : ref.nextSibling ) );
	});
	var onloadcssdefined = function( cb ){
		var resolvedHref = ss.href;
		var i = sheets.length;
		while( i-- ){
			if( sheets[ i ].href === resolvedHref ){
				return cb();
			}
		}
		setTimeout(function() {
			onloadcssdefined( cb );
		});
	};
	function loadCB(){
		if( ss.addEventListener ){
			ss.removeEventListener( "load", loadCB );
		}
		ss.media = media || "all";
	}
	if( ss.addEventListener ){
		ss.addEventListener( "load", loadCB);
	}
	ss.onloadcssdefined = onloadcssdefined;
	onloadcssdefined( loadCB );
	return ss;
};
</script>
<script>
  
  loadCSS("https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14/css/all.min.css", window.volantis.loadcss);
  
  
  
  
  loadCSS("https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10/build/styles/solarized-light.min.css", window.volantis.loadcss);
  
</script>
<!-- required -->

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5/dist/jquery.min.js"></script>

<script>
  function pjax_fancybox() {
    $(".md .gallery").find("img").each(function () { //渲染 fancybox
      var element = document.createElement("a"); // a 标签
      $(element).attr("class", "fancybox");
      $(element).attr("pjax-fancybox", "");  // 过滤 pjax
      $(element).attr("href", $(this).attr("src"));
      if ($(this).attr("data-original")) {
        $(element).attr("href", $(this).attr("data-original"));
      }
      $(element).attr("data-fancybox", "images");
      var caption = "";   // 描述信息
      if ($(this).attr('alt')) {  // 判断当前页面是否存在描述信息
        $(element).attr('data-caption', $(this).attr('alt'));
        caption = $(this).attr('alt');
      }
      var div = document.createElement("div");
      $(div).addClass("fancybox");
      $(this).wrap(div); // 最外层套 div ，其实主要作用还是 class 样式
      var span = document.createElement("span");
      $(span).addClass("image-caption");
      $(span).text(caption); // 加描述
      $(this).after(span);  // 再套一层描述
      $(this).wrap(element);  // 最后套 a 标签
    })
    $(".md .gallery").find("img").fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
      closeClick: true,
      helpers: {
        overlay: {closeClick: true}
      },
      buttons: [
        "zoom",
        "close"
      ]
    });
  };
  function SCload_fancybox() {
    if ($(".md .gallery").find("img").length == 0) return;
    loadCSS("https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css", document.getElementById("loadcss"));
    setTimeout(function() {
      loadScript('https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js', pjax_fancybox)
    }, 1);
  };
  $(function () {
    SCload_fancybox();
  });
</script>


<!-- internal -->







  <script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>




  
  
    <script>
      window.FPConfig = {
        delay: 0,
        ignoreKeywords: [],
        maxRPS: 5,
        hoverDelay: 25
      };
    </script>
    <script defer src="https://cdn.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"></script>
  




  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
    var clipboard = new ClipboardJS('.btn-copy', {
        target: function (trigger) {
            return trigger.nextElementSibling
        }
    });
    function wait(callback, seconds) {
        var timelag = null;
        timelag = window.setTimeout(callback, seconds)
    }
    function pjax_initCopyCode() {
		if($(".highlight .code pre").length+$(".article pre code").length==0)return;
        var copyHtml = '';
        copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
        copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
        copyHtml += '</button>';
        $(".highlight .code pre").before(copyHtml);
        $(".article pre code").before(copyHtml);
        clipboard.off('success').on('success', function (e) {
            let $btn = $(e.trigger);
            $btn.addClass('copied');
            let $icon = $($btn.find('i'));
            $icon.removeClass('fa-copy');
            $icon.addClass('fa-check-circle');
            let $span = $($btn.find('span'));
            $span[0].innerText = 'COPIED';
            wait(function () {
                $icon.removeClass('fa-check-circle');
                $icon.addClass('fa-copy');
                $span[0].innerText = 'COPY'
            }, 2000)
        });
        clipboard.off('error').on('error', function (e) {
            e.clearSelection();
            let $btn = $(e.trigger);
            $btn.addClass('copy-failed');
            let $icon = $($btn.find('i'));
            $icon.removeClass('fa-copy');
            $icon.addClass('fa-times-circle');
            let $span = $($btn.find('span'));
            $span[0].innerText = 'COPY FAILED';
            wait(function () {
                $icon.removeClass('fa-times-circle');
                $icon.addClass('fa-copy');
                $span[0].innerText = 'COPY'
            }, 2000)
        })
    }
    $(function () {
        pjax_initCopyCode()
    });
</script>




   <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.6/dist/scrollreveal.min.js"></script>
<script type="text/javascript">
  function pjax_scrollrebeal() {
    ScrollReveal().reveal('.l_main .reveal', {
      distance: '32px',
      duration: '800',
      interval: '20',
      scale: '1',
      easing: 'ease-out'
    });
  }
  $(function () {
    pjax_scrollrebeal();
  });
</script>






  
  
<script src="/js/valine.js"></script>


<script>
  var GUEST_INFO = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link'.split(',').filter(function (item) {
    return GUEST_INFO.indexOf(item) > -1
  });
  var REQUIRED_FIELDS = ['nick', 'mail', 'link'];
  var requiredFields = 'nick,mail'.split(',').filter(function (item) {
    return REQUIRED_FIELDS.indexOf(item) > -1
  });

  function emoji(path, idx, ext) {
    return path + "/" + path + "-" + idx + "." + ext;
  }

  var emojiMaps = {};
  for (var i = 1; i <= 54; i++) {
    emojiMaps['tieba-' + i] = emoji('tieba', i, 'png');
  }
  for (var i = 1; i <= 101; i++) {
    emojiMaps['qq-' + i] = emoji('qq', i, 'gif');
  }
  for (var i = 1; i <= 116; i++) {
    emojiMaps['aru-' + i] = emoji('aru', i, 'gif');
  }
  for (var i = 1; i <= 125; i++) {
    emojiMaps['twemoji-' + i] = emoji('twemoji', i, 'png');
  }
  for (var i = 1; i <= 4; i++) {
    emojiMaps['weibo-' + i] = emoji('weibo', i, 'png');
  }

  function pjax_valine() {
    if(!document.querySelectorAll("#valine_container")[0])return;

    let pagePlaceholder = pdata.commentPlaceholder || "快来评论吧~";

    let path = pdata.commentPath;
    if (path.length == 0) {
      let defaultPath = '';
      path = defaultPath || decodeURI(window.location.pathname);
    }

    var valine = new Valine();
    valine.init({
      el: '#valine_container',
      meta: meta,
      placeholder: pagePlaceholder,
      path: path,
      appId: "gS8ihDFgPI3BFumYwUjcDcCa-gzGzoHsz",
      appKey: "KR6OTPyeUivEczKuDaEs95kK",
      pageSize: '10',
      avatar: 'identicon',
      lang: 'zh-cn',
      visitor: 'true',
      highlight: 'true',
      mathJax: 'true',
      enableQQ: 'true',
      recordIP: 'false',
      requiredFields: requiredFields,
      emojiCDN: 'https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/valine/',
      emojiMaps: emojiMaps
    })
  }

  $(function () {
    pjax_valine();
  });
</script>





  
<script src="/js/app.js"></script>



<!-- optional -->

  <script>
const SearchServiceimagePath="https://cdn.jsdelivr.net/gh/volantis-x/cdn-volantis@master/img/";
const ROOT =  ("/" || "/").endsWith('/') ? ("/" || "/") : ("//" || "/" );

$('.input.u-search-input').one('focus',function(){
	
		loadScript('/js/search/hexo.js',setSearchService);
	
})

function listenSearch(){
  
    customSearch = new HexoSearch({
      imagePath: SearchServiceimagePath
    });
  
}
function setSearchService() {
	listenSearch();
	
}
</script>









  
    
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10/build/highlight.min.js"></script>

    <script>hljs.initHighlightingOnLoad();</script>
  



  <script defer>

  const LCCounter = {
    app_id: 'u9j57bwJod4EDmXWdxrwuqQT-MdYXbMMI',
    app_key: 'jfHtEKVE24j0IVCGHbvuFClp',
    custom_api_server: '',

    // 查询存储的记录
    getRecord(Counter, url, title) {
      return new Promise(function (resolve, reject) {
        Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({url})))
          .then(resp => resp.json())
          .then(({results, code, error}) => {
            if (code === 401) {
              throw error;
            }
            if (results && results.length > 0) {
              var record = results[0];
              resolve(record);
            } else {
              Counter('post', '/classes/Counter', {url, title: title, times: 0})
                .then(resp => resp.json())
                .then((record, error) => {
                  if (error) {
                    throw error;
                  }
                  resolve(record);
                }).catch(error => {
                console.error('Failed to create', error);
                reject(error);
              });
            }
          }).catch((error) => {
          console.error('LeanCloud Counter Error:', error);
          reject(error);
        });
      })
    },

    // 发起自增请求
    increment(Counter, incrArr) {
      return new Promise(function (resolve, reject) {
        Counter('post', '/batch', {
          "requests": incrArr
        }).then((res) => {
          res = res.json();
          if (res.error) {
            throw res.error;
          }
          resolve(res);
        }).catch((error) => {
          console.error('Failed to save visitor count', error);
          reject(error);
        });
      });
    },

    // 构建自增请求体
    buildIncrement(objectId) {
      return {
        "method": "PUT",
        "path": `/1.1/classes/Counter/${ objectId }`,
        "body": {
          "times": {
            '__op': 'Increment',
            'amount': 1
          }
        }
      }
    },

    // 校验是否为有效的 UV
    validUV() {
      var key = 'LeanCloudUVTimestamp';
      var flag = localStorage.getItem(key);
      if (flag) {
        // 距离标记小于 24 小时则不计为 UV
        if (new Date().getTime() - parseInt(flag) <= 86400000) {
          return false;
        }
      }
      localStorage.setItem(key, new Date().getTime().toString());
      return true;
    },

    addCount(Counter) {
      var enableIncr = '' === 'true' && window.location.hostname !== 'localhost';
      enableIncr = true;
      var getterArr = [];
      var incrArr = [];
      // 请求 PV 并自增
      var pvCtn = document.querySelector('#lc-sv');
      if (pvCtn || enableIncr) {
        var pvGetter = this.getRecord(Counter, 'http://y-ume.com' + '/#lc-sv', 'Visits').then((record) => {
          incrArr.push(this.buildIncrement(record.objectId))
          var eles = document.querySelectorAll('#lc-sv #number');
          if (eles.length > 0) {
            eles.forEach((el,index,array)=>{
              el.innerText = record.times + 1;
              if (pvCtn) {
                pvCtn.style.display = 'inline';
              }
            })
          }
        });
        getterArr.push(pvGetter);
      }

      // 请求 UV 并自增
      var uvCtn = document.querySelector('#lc-uv');
      if (uvCtn || enableIncr) {
        var uvGetter = this.getRecord(Counter, 'http://y-ume.com' + '/#lc-uv', 'Visitors').then((record) => {
          var vuv = this.validUV();
          vuv && incrArr.push(this.buildIncrement(record.objectId))
          var eles = document.querySelectorAll('#lc-uv #number');
          if (eles.length > 0) {
            eles.forEach((el,index,array)=>{
              el.innerText = record.times + (vuv ? 1 : 0);
              if (uvCtn) {
                uvCtn.style.display = 'inline';
              }
            })
          }
        });
        getterArr.push(uvGetter);
      }

      // 请求文章的浏览数，如果是当前页面就自增
      var allPV = document.querySelectorAll('#lc-pv');
      if (allPV.length > 0 || enableIncr) {
        for (i = 0; i < allPV.length; i++) {
          let pv = allPV[i];
          let title = pv.getAttribute('data-title');
          var url = 'http://y-ume.com' + pv.getAttribute('data-path');
          if (url) {
            var viewGetter = this.getRecord(Counter, url, title).then((record) => {
              // 是当前页面就自增
              let curPath = window.location.pathname;
              if (curPath.includes('index.html')) {
                curPath = curPath.substring(0, curPath.lastIndexOf('index.html'));
              }
              if (pv.getAttribute('data-path') == curPath) {
                incrArr.push(this.buildIncrement(record.objectId));
              }
              if (pv) {
                var ele = pv.querySelector('#lc-pv #number');
                if (ele) {
                  if (pv.getAttribute('data-path') == curPath) {
                    ele.innerText = (record.times || 0) + 1;
                  } else {
                    ele.innerText = record.times || 0;
                  }
                  pv.style.display = 'inline';
                }
              }
            });
            getterArr.push(viewGetter);
          }
        }
      }

      // 如果启动计数自增，批量发起自增请求
      if (enableIncr) {
        Promise.all(getterArr).then(() => {
          incrArr.length > 0 && this.increment(Counter, incrArr);
        })
      }

    },


    fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${ api_server }/1.1${ url }`, {
          method,
          headers: {
            'X-LC-Id': this.app_id,
            'X-LC-Key': this.app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      this.addCount(Counter);
    },

    refreshCounter() {
      var api_server = this.app_id.slice(-9) !== '-MdYXbMMI' ? this.custom_api_server : `https://${ this.app_id.slice(0, 8).toLowerCase() }.api.lncldglobal.com`;
      if (api_server) {
        this.fetchData(api_server);
      } else {
        fetch('https://app-router.leancloud.cn/2/route?appId=' + this.app_id)
          .then(resp => resp.json())
          .then(({api_server}) => {
            this.fetchData('https://' + api_server);
          });
      }
    }

  };

  LCCounter.refreshCounter();

  document.addEventListener('pjax:complete', function () {
    LCCounter.refreshCounter();
  });
</script>








<script>
function listennSidebarTOC() {
  const navItems = document.querySelectorAll(".toc li");
  if (!navItems.length) return;
  const sections = [...navItems].map((element) => {
    const link = element.querySelector(".toc-link");
    const target = document.getElementById(
      decodeURI(link.getAttribute("href")).replace("#", "")
    );
    link.addEventListener("click", (event) => {
      event.preventDefault();
      window.scrollTo({
		top: target.offsetTop + 100,
		
		behavior: "smooth"
		
	  });
    });
    return target;
  });

  function activateNavByIndex(target) {
    if (target.classList.contains("active-current")) return;

    document.querySelectorAll(".toc .active").forEach((element) => {
      element.classList.remove("active", "active-current");
    });
    target.classList.add("active", "active-current");
    let parent = target.parentNode;
    while (!parent.matches(".toc")) {
      if (parent.matches("li")) parent.classList.add("active");
      parent = parent.parentNode;
    }
  }

  function findIndex(entries) {
    let index = 0;
    let entry = entries[index];
    if (entry.boundingClientRect.top > 0) {
      index = sections.indexOf(entry.target);
      return index === 0 ? 0 : index - 1;
    }
    for (; index < entries.length; index++) {
      if (entries[index].boundingClientRect.top <= 0) {
        entry = entries[index];
      } else {
        return sections.indexOf(entry.target);
      }
    }
    return sections.indexOf(entry.target);
  }

  function createIntersectionObserver(marginTop) {
    marginTop = Math.floor(marginTop + 10000);
    let intersectionObserver = new IntersectionObserver(
      (entries, observe) => {
        let scrollHeight = document.documentElement.scrollHeight + 100;
        if (scrollHeight > marginTop) {
          observe.disconnect();
          createIntersectionObserver(scrollHeight);
          return;
        }
        let index = findIndex(entries);
        activateNavByIndex(navItems[index]);
      },
      {
        rootMargin: marginTop + "px 0px -100% 0px",
        threshold: 0,
      }
    );
    sections.forEach((element) => {
      element && intersectionObserver.observe(element);
    });
  }
  createIntersectionObserver(document.documentElement.scrollHeight);
}

document.addEventListener("DOMContentLoaded", listennSidebarTOC);
document.addEventListener("pjax:success", listennSidebarTOC);
</script>

<!-- more -->




    
      


<script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script>


<script>
    var pjax;
    document.addEventListener('DOMContentLoaded', function () {
      pjax = new Pjax({
        elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([pjax-fancybox])',
        selectors: [
          "title",
          "#l_cover",
          "#pjax-container",
          "#pjax-header-nav-list"
        ],
        cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
        timeout: 5000
      });
    });

    document.addEventListener('pjax:send', function (e) {
      //window.stop(); // 相当于点击了浏览器的停止按钮

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      window.subData = null; // 移除标题（用于一二级导航栏切换处）
      if (typeof $.fancybox != "undefined") {
        $.fancybox.close();    // 关闭弹窗
      }
      volantis.$switcher.removeClass('active'); // 关闭移动端激活的搜索框
      volantis.$header.removeClass('z_search-open'); // 关闭移动端激活的搜索框
      volantis.$wrapper.removeClass('sub'); // 跳转页面时关闭二级导航

      // 解绑事件 避免重复监听
      volantis.$topBtn.unbind('click');
      $('.menu a').unbind('click');
      $(window).unbind('resize');
      $(window).unbind('scroll');
      $(document).unbind('scroll');
      $(document).unbind('click');
      $('body').unbind('click');
	  
    });

    document.addEventListener('pjax:complete', function () {
      // 关于百度统计对 SPA 页面的处理：
      // 方案一：百度统计>管理>单页应用设置中，打开开启按钮即可对SPA进行统计。 https://tongji.baidu.com/web/help/article?id=324
      // 方案二：取消注释下列代码。 https://tongji.baidu.com/web/help/article?id=235
       

      // 关于谷歌统计对 SPA 页面的处理：
      // 当应用以动态方式加载内容并更新地址栏中的网址时，也应该更新通过 gtag.js 存储的网页网址。
      // https://developers.google.cn/analytics/devguides/collection/gtagjs/single-page-applications?hl=zh-cn
      
	 

      $('.nav-main').find('.list-v').not('.menu-phone').removeAttr("style",""); // 移除小尾巴的移除
      $('.menu-phone.list-v').removeAttr("style",""); // 移除小尾巴的移除
      $('script[data-pjax], .pjax-reload script').each(function () {
        $(this).parent().append($(this).remove());
      });
      try{
          if (typeof $.fancybox == "undefined") {
            SCload_fancybox();
          } else {
            pjax_fancybox();
          }
        
        
        document.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightBlock(block);
        });
        
        
          pjax_scrollrebeal();
        
        
        
          pjax_initCopyCode();
        
        
          pjax_valine();
        
        
        
        
        
      } catch (e) {
        console.log(e);
      }
	  
    });

    document.addEventListener('pjax:error', function (e) {
	  
      window.location.href = e.triggerElement.href;
    });
</script>

    
  </div>
</body>
</html>
